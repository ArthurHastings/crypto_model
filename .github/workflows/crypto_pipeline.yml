name: Daily Crypto Pipeline

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.0'

      - name: Install dependencies
        run: pip install -r requirements.txt
        
      - name: Install NLTK
        run: |
          pip install nltk
          python -c "import nltk, os; path=os.path.join(os.getcwd(), 'nltk_data'); nltk.download('punkt', download_dir=path); nltk.download('stopwords', download_dir=path); nltk.download('wordnet', download_dir=path)"

      - name: Set NLTK_DATA environment variable
        run: echo "NLTK_DATA=/usr/local/share/nltk_data" >> $GITHUB_ENV

      - name: Start MLflow model server on port 5003
        run: |
          nohup mlflow server --host 0.0.0.0 --port 5003 &> mlflow.log &
      
      - name: Deploy Model on port 5002
        run: |
          python deploy_model.py

      - name: Install ngrok v2
        run: |
          curl -sSL https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -o ngrok.zip
          unzip ngrok.zip
          sudo mv ngrok /usr/local/bin
      
      - name: Check ngrok version
        run: ngrok version

      - name: Authenticate ngrok
        run: ngrok config add-authtoken ${{ secrets.NGROK_AUTHTOKEN }}

      - name: Start ngrok and expose model API
        run: |
          # Start ngrok in the background and expose your local model API (port 5002)
          nohup ngrok http 5002 &

          # Wait for ngrok to initialize and ensure the public URL is ready
          echo "Waiting for ngrok to initialize..."
          for i in {1..10}; do
            PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
            echo "PUBLIC_URL=$PUBLIC_URL" >> $GITHUB_ENV
            if [[ "$PUBLIC_URL" != "null" && -n "$PUBLIC_URL" ]]; then
              echo "Public URL is ready: $PUBLIC_URL"
              break
            fi
            sleep 3
          done

          if [[ -z "$PUBLIC_URL" ]]; then
            echo "ngrok failed to provide a public URL."
            exit 1
          fi

          # Debugging: Print the PUBLIC_URL
          echo "Final PUBLIC_URL: $PUBLIC_URL"

      - name: Set API URL environment variable
        run: |
          echo "API_SENTIMENT_MODEL=${{ env.PUBLIC_URL }}/invocations" >> $GITHUB_ENV

      # -------------------------------------------------------------------------------------------

      # - name: Run get_news_sentences.py
      #   run: python get_news_sentences.py
      #   env:
      #     API_SENTIMENT_MODEL: ${{ env.API_SENTIMENT_MODEL }}

      # - name: Preprocess sentiments
      #   run: python clean_headline_sentiment.py

      # - name: Combine final dataset
      #   run: python generate_csv.py

      - name: Authenticate 2nd ngrok
        run: ngrok config add-authtoken ${{ secrets.NGROK_AUTHTOKEN_5001 }}

      - name: Start ngrok and expose MLflow on 5003
        run: |
          # Start ngrok in the background and expose your local model API (port 5003)
          nohup ngrok http 5003 --log=stdout --web-addr=:4041 > ngrok_mlflow.log &
          
          echo "Waiting for ngrok (MLflow) to initialize..."
          for i in {1..10}; do
            PUBLIC_URL_2=$(curl -s http://localhost:4041/api/tunnels | jq -r '.tunnels[0].public_url')
            echo "PUBLIC_URL_2=$PUBLIC_URL_2" >> $GITHUB_ENV
            if [[ "$PUBLIC_URL_2" != "null" && -n "$PUBLIC_URL_2" ]]; then
              echo "MLflow Public URL is ready: $PUBLIC_URL_2"
              break
            fi
            sleep 3
          done

          if [[ -z "$PUBLIC_URL_2" ]]; then
            echo "ngrok failed to provide a public URL for MLflow."
            exit 1
          fi

          # Debugging: Print the PUBLIC_URL_2
          echo "Final PUBLIC_URL_2: $PUBLIC_URL_2"

      - name: Set API URL environment variable
        run: |
          echo "MLFLOW_NGROK=${{ env.PUBLIC_URL_2 }}" >> $GITHUB_ENV

      - name: Predict tomorrow's price
        run: python price_model.py
        env:
          MLFLOW_NGROK: ${{ env.MLFLOW_NGROK }}
      
      - name: Upload prediction result
        uses: actions/upload-artifact@v4
        with:
          name: prediction_result
          path: prediction_result.txt

# 2vjKe8gcVkpxr6d6NW2uVeQm5VJ_4yWBF6Qu2MMLi2UarA4wT : 5002
# 2wFydqD901sz9dzcxcfpfxocQvD_58Ex39kxnNgMR7gWiV8jL : 5001